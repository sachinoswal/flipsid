<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlipSid - Trade Sports Cards with Friends</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23ffd93d'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>‚öΩ</text></svg>">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 100%);
            min-height: 100vh;
        }

        header {
            background: linear-gradient(135deg, #ffd93d 0%, #ffaf00 100%);
            padding: 20px 0;
            box-shadow: 0 4px 15px rgba(255, 175, 0, 0.3);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .logo-text {
            font-size: 2em;
            font-weight: 900;
            color: white;
            text-transform: uppercase;
            font-family: 'Arial Black', sans-serif;
            letter-spacing: -1px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .nav-buttons button {
            background: white;
            color: #ffaf00;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }

        .nav-buttons button:hover {
            transform: translateY(-2px);
        }

        .nav-buttons .btn-primary {
            background: linear-gradient(135deg, #ffd93d, #ffaf00);
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .auth-container {
            max-width: 450px;
            margin: 60px auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255, 175, 0, 0.2);
            border: 3px solid #ffd93d;
        }

        .auth-container h2 {
            color: #ffaf00;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffd93d;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #ffaf00;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #ffd93d, #ffaf00);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 175, 0, 0.4);
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .auth-switch a {
            color: #ffaf00;
            text-decoration: none;
            font-weight: bold;
        }

        .pending-message {
            background: #fff9e6;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 3px solid #ffd93d;
        }

        .pending-message h2 {
            color: #ffaf00;
            margin-bottom: 15px;
        }

        .pending-message p {
            color: #666;
            font-size: 1.1em;
        }

        .dashboard-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(255, 175, 0, 0.1);
            border-left: 5px solid #ffd93d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-header h1 {
            color: #ffaf00;
            margin-bottom: 10px;
        }

        .dashboard-header p {
            color: #666;
        }

        .flipcoins-badge {
            background: linear-gradient(135deg, #ffd93d, #ffaf00);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(255, 175, 0, 0.3);
        }

        .flipcoins-badge .amount {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }

        .flipcoins-badge .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(255, 175, 0, 0.1);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 140px;
            padding: 15px;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
            text-align: center;
        }

        .tab.active {
            background: linear-gradient(135deg, #ffd93d, #ffaf00);
            color: white;
            border-color: #ffd93d;
        }

        .tab:hover:not(.active) {
            background: #fff9e6;
            border-color: #ffd93d;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .card-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(255, 175, 0, 0.15);
            border: 2px solid #ffd93d;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 175, 0, 0.3);
        }

        .card-images {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .card-image {
            flex: 1;
            height: 180px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            overflow: hidden;
            border: 2px solid #ffd93d;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            cursor: pointer;
        }

        .card-image:hover {
            opacity: 0.9;
        }

        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-info {
            margin-top: 15px;
        }

        .card-info h3 {
            color: #ffaf00;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .card-detail {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: #fff9e6;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .card-detail strong {
            color: #666;
        }

        .card-detail span {
            color: #333;
            font-weight: 600;
        }

        .sport-badge {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, #ffd93d, #ffaf00);
            color: white;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .tag {
            background: #e0e0e0;
            color: #333;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .tag.halloffame {
            background: #FFD700;
            color: #000;
        }

        .tag.rookie {
            background: #4CAF50;
            color: white;
        }

        .tag.limited {
            background: #f44336;
            color: white;
        }

        .card-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            flex: 1;
            min-width: 45%;
            padding: 10px;
            background: linear-gradient(135deg, #ffd93d, #ffaf00);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 0.9em;
        }

        .btn-small:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: white;
            color: #ffaf00;
            border: 2px solid #ffd93d;
        }

        .btn-icon {
            padding: 8px 12px;
            font-size: 1.2em;
        }

        .btn-active {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .like-counter {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            color: #ff4444;
            font-weight: bold;
        }

        .interaction-counters {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .interaction-counter {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 6px;
            transition: background 0.2s;
            font-size: 0.9em;
        }

        .interaction-counter:hover {
            background: #fff9e6;
        }

        .interaction-counter.likes {
            color: #ff4444;
        }

        .interaction-counter.owns {
            color: #4CAF50;
        }

        .interaction-counter.wantsToBuy {
            color: #2196F3;
        }

        .interaction-counter.wantsToSell {
            color: #FF9800;
        }

        .user-list-item {
            padding: 15px;
            background: #fff9e6;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #ffd93d;
        }

        .user-list-item strong {
            color: #ffaf00;
            font-size: 1.1em;
        }

        .follow-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #ffd93d, #ffaf00);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .follow-btn:hover {
            transform: translateY(-2px);
        }

        .follow-btn.following {
            background: #4CAF50;
        }

        .btn-edit-card {
            background: #2196F3;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .file-upload {
            border: 2px dashed #ffd93d;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
            background: #fff9e6;
        }

        .file-upload:hover {
            background: #fff4d6;
        }

        .file-upload input {
            display: none;
        }

        .file-upload-text {
            color: #ffaf00;
            font-weight: bold;
            margin-top: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 15px;
            border: 2px dashed #ffd93d;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #ffaf00;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #666;
        }

        .hidden {
            display: none !important;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-weight: bold;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffaf00;
            font-weight: bold;
        }

        .user-avatar-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
        }

        .profile-pic-upload {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #ffd93d;
            margin: 0 auto 20px;
            display: block;
            cursor: pointer;
        }

        .profile-pic-placeholder {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            border: 3px dashed #ffd93d;
            cursor: pointer;
            font-size: 2em;
        }

        .card-id-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
        }

        .sport-icon {
            font-size: 1.2em;
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(255, 175, 0, 0.1);
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-input {
            padding: 10px;
            border: 2px solid #ffd93d;
            border-radius: 8px;
            font-size: 0.95em;
        }

        .filter-input:focus {
            outline: none;
            border-color: #ffaf00;
        }

        .action-tags {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .action-tag {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .action-tag.liked {
            background: #ffebee;
            color: #ff4444;
        }

        .action-tag.owned {
            background: #e8f5e9;
            color: #4CAF50;
        }

        .action-tag.wanted {
            background: #e3f2fd;
            color: #2196F3;
        }

        .action-tag.selling {
            background: #fff3e0;
            color: #FF9800;
        }

        .tutorial-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }

        .tutorial-box h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .tutorial-box a {
            color: #1976d2;
            font-weight: bold;
        }

        .image-preview {
            width: 100%;
            max-width: 150px;
            height: 150px;
            border-radius: 8px;
            object-fit: cover;
            margin-top: 10px;
        }

        .preview-container {
            position: relative;
            display: inline-block;
        }

        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-weight: bold;
        }

        .admin-panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(255, 175, 0, 0.15);
            border: 2px solid #ff4444;
        }

        .admin-panel h3 {
            color: #ff4444;
            margin-bottom: 20px;
        }

        .pending-users, .pending-cards-list {
            display: grid;
            gap: 15px;
        }

        .pending-user, .pending-card {
            background: #fff9e6;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ffd93d;
        }

        .pending-card {
            display: grid;
            grid-template-columns: 200px 1fr auto;
            gap: 20px;
            align-items: start;
        }

        .pending-user-info, .pending-card-info {
            flex: 1;
        }

        .pending-user-info strong, .pending-card-info strong {
            color: #ffaf00;
            font-size: 1.1em;
        }

        .pending-user-info p, .pending-card-info p {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .pending-user-actions, .pending-card-actions {
            display: flex;
            gap: 10px;
            flex-direction: column;
        }

        .btn-approve {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-reject {
            background: #ff4444;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-edit {
            background: #2196F3;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .admin-badge {
            background: #ff4444;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #ffd93d;
        }

        .edit-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .section-header {
            background: linear-gradient(135deg, #ffd93d, #ffaf00);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 30px 0 20px 0;
            font-size: 1.2em;
            font-weight: bold;
        }

        .section-header:first-child {
            margin-top: 0;
        }

        .uploader-badge {
            font-size: 0.85em;
            color: #999;
            margin-top: 5px;
        }

        .stats-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.9em;
            display: inline-block;
            margin-top: 10px;
        }

        .notification-badge {
            background: #ff4444;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .card-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-title-row h3 {
            color: #ffaf00;
            font-size: 1.1em;
            margin: 0;
            flex: 1;
        }

        .card-title-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .heart-icon {
            font-size: 1.3em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: transform 0.2s;
            user-select: none;
        }

        .heart-icon:hover {
            transform: scale(1.2);
        }

        .heart-icon.liked {
            animation: heartbeat 0.3s ease;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        .heart-count {
            font-size: 0.7em;
            color: #ff4444;
            font-weight: bold;
            cursor: pointer;
        }

        .heart-count:hover {
            text-decoration: underline;
        }

        /* Admin Page Styles */
        .admin-page {
            display: none;
        }

        .admin-page.active {
            display: block;
        }

        .admin-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(255,0,0,0.1);
            border: 2px solid #ff4444;
            flex-wrap: wrap;
        }

        .admin-tab {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            text-align: center;
            transition: all 0.3s;
        }

        .admin-tab.active {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            border-color: #ff4444;
        }

        .admin-tab:hover:not(.active) {
            background: #fff0f0;
            border-color: #ff4444;
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-header-btn {
            background: rgba(255,255,255,0.3);
            color: white;
            border: 2px solid white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .admin-header-btn:hover {
            background: white;
            color: #ff4444;
        }

        .password-reset-form {
            background: #fff9e6;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ffd93d;
            margin-top: 15px;
        }

        .admin-user-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 2px solid #eee;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .admin-card-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 2px solid #eee;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .admin-user-info {
            flex: 1;
            min-width: 200px;
        }

        .admin-user-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .pending-highlight {
            border-color: #FF9800 !important;
            background: #fff8f0 !important;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">‚öΩ</div>
                <div class="logo-text">FlipSid</div>
            </div>
            <div class="nav-buttons">
                <div id="userSection" class="hidden">
                    <span class="user-info">
                        <img id="userProfilePic" class="user-avatar-img" src="" alt="" style="display:none;">
                        <span class="user-avatar" id="userAvatar"></span>
                        <span id="userName"></span>
                        <span style="color: white; margin-left: 5px;">(üí∞ <span id="headerFlipcoins">0</span>)</span>
                        <span id="adminBadge" class="admin-badge hidden">ADMIN</span>
                    </span>
                    <button id="adminPageBtn" class="admin-header-btn hidden" onclick="showAdminPage()">‚öôÔ∏è Admin</button>
                    <button onclick="showEditProfile()" style="background:rgba(255,255,255,0.2); color:white; border:2px solid white; padding:8px 16px; border-radius:8px; font-weight:bold; cursor:pointer;">Edit Profile</button>
                    <button onclick="logout()" style="background:rgba(255,255,255,0.2); color:white; border:2px solid white; padding:8px 16px; border-radius:8px; font-weight:bold; cursor:pointer;">Logout</button>
                </div>
                <div id="authButtons">
                    <button onclick="showLogin()">Login</button>
                    <button class="btn-primary" onclick="showSignup()">Sign Up</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Login Form -->
        <div id="loginForm" class="auth-container hidden">
            <h2>Welcome Back! üëã</h2>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label>Nickname</label>
                    <input type="text" id="loginNickname" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div style="position: relative;">
                        <input type="password" id="loginPassword" required style="padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('loginPassword', 'loginEye')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2em;">
                            <span id="loginEye">üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>
            <div class="auth-switch">
                Don't have an account? <a href="#" onclick="showSignup()">Sign Up</a>
            </div>
        </div>

        <!-- Signup Form -->
        <div id="signupForm" class="auth-container hidden">
            <h2>Join FlipSid! üéâ</h2>
            <form onsubmit="signup(event)">
                <div class="form-group">
                    <label>Profile Picture</label>
                    <div class="profile-pic-placeholder" onclick="document.getElementById('signupProfilePic').click()">
                        üì∑
                    </div>
                    <input type="file" id="signupProfilePic" accept="image/*" style="display:none;" onchange="previewProfilePic(this, 'signupProfilePreview')">
                    <img id="signupProfilePreview" class="profile-pic-upload" style="display:none;">
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="signupFullName" required placeholder="Your real name (kept private)">
                </div>
                <div class="form-group">
                    <label>Nickname</label>
                    <input type="text" id="signupNickname" required placeholder="e.g., CricketKing, FootyFan">
                </div>
                <div class="form-group">
                    <label>Mobile Number</label>
                    <input type="tel" id="signupPhone" required placeholder="Used for login (kept private)">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div style="position: relative;">
                        <input type="password" id="signupPassword" required style="padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility('signupPassword', 'signupEye')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2em;">
                            <span id="signupEye">üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn">Sign Up</button>
            </form>
            <div class="auth-switch">
                Already have an account? <a href="#" onclick="showLogin()">Login</a>
            </div>
        </div>

        <!-- Pending Approval -->
        <div id="pendingApproval" class="auth-container hidden">
            <div class="pending-message">
                <div style="font-size: 4em; margin-bottom: 20px;">‚è≥</div>
                <h2>Registration Pending</h2>
                <p>Thanks for signing up!</p>
                <div style="background: #fff9e6; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: left; border: 2px solid #ffd93d;">
                    <p style="color: #333; line-height: 1.6;">
                        Hello, I'm <strong>Sid</strong> and welcome to <strong>FlipSid</strong> (read as Flip Side). If you are here, you probably know me. This hobby project is a bridge between my passion for football, desire to pick new computer skills and an urge to earn some money :-). 
                        <br><br>
                        I built this under the strict supervision of my parents using AI tools like Claude. Since you are mostly not an adult like me, access to this website from your end should also be strictly under your parent's supervision. 
                        <br><br>
                        <strong>To approve your login please ask your parent to speak with my parents.</strong> This is to save all of us troublemakers more trouble. 
                        <br><br>
                        Thank you for your understanding. I hope to build a lot of things around sports so do share your feedback with me.
                        <br><br>
                        - Sid
                    </p>
                </div>
                <button class="btn" onclick="showLogin()" style="margin-top: 20px;">Back to Login</button>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('browse')">üîç Browse Cards</div>
                <div class="tab" onclick="switchTab('upload')">üì§ Upload Cards</div>
                <div class="tab" onclick="switchTab('yourCards')">üíù Your Cards</div>
                <div class="tab" onclick="switchTab('friends')">üë• Your Friends<span id="friendRequestBadge" class="notification-badge" style="display:none;"></span></div>
            </div>

            <!-- Browse Cards Tab -->
            <div id="browseTab" class="tab-content active">
                <div class="filter-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="color:#ffaf00; margin:0;">üîç Filter Cards</h3>
                        <button class="btn-small" onclick="clearFilters()" style="flex:none !important; min-width:auto !important; width:auto; padding:8px 16px; font-size:0.9em;">Clear Filters</button>
                    </div>
                    <div class="filter-row">
                        <input type="text" class="filter-input" id="searchText" placeholder="Search player name..." onkeyup="applyFilters()">
                        <select class="filter-input" id="filterTeam" onchange="applyFilters()">
                            <option value="">All Teams</option>
                        </select>
                        <select class="filter-input" id="filterType" onchange="applyFilters()">
                            <option value="">All Types</option>
                        </select>
                        <select class="filter-input" id="filterCompany" onchange="applyFilters()">
                            <option value="">All Companies</option>
                            <option value="Topps Match Attax">Topps Match Attax</option>
                            <option value="Premier League">Premier League</option>
                        </select>
                    </div>
                </div>
                <div id="browseCardsList" class="cards-grid"></div>
            </div>

            <!-- Upload Cards Tab -->
            <div id="uploadTab" class="tab-content">
                <div class="tutorial-box">
                    <h4>üì∫ How to Upload Cards</h4>
                    <p>Need help getting card images and data? <a href="https://www.youtube.com/results?search_query=how+to+photograph+trading+cards" target="_blank">Watch this tutorial</a> on how to photograph your trading cards properly.</p>
                    <p style="margin-top: 10px;"><strong>Tips:</strong> Use good lighting, keep the camera steady, and make sure the card fills most of the frame!</p>
                </div>
                <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(255, 175, 0, 0.15); border: 2px solid #ffd93d;">
                    <h3 style="color: #ffaf00; margin-bottom: 25px; font-size: 1.5em;">üì§ Upload New Card</h3>
                    <form onsubmit="uploadCard(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Card Front Picture</label>
                                <div class="file-upload" onclick="document.getElementById('uploadFrontImage').click()">
                                    <div style="font-size: 2em;">üì∑</div>
                                    <div class="file-upload-text">Upload Front Image</div>
                                    <input type="file" id="uploadFrontImage" accept="image/*" onchange="previewImage(this, 'uploadFrontPreview')">
                                </div>
                                <div id="uploadFrontPreview"></div>
                            </div>
                            <div class="form-group">
                                <label>Card Back Picture</label>
                                <div class="file-upload" onclick="document.getElementById('uploadBackImage').click()">
                                    <div style="font-size: 2em;">üì∑</div>
                                    <div class="file-upload-text">Upload Back Image</div>
                                    <input type="file" id="uploadBackImage" accept="image/*" onchange="previewImage(this, 'uploadBackPreview')">
                                </div>
                                <div id="uploadBackPreview"></div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Player Name</label>
                                <input type="text" id="uploadPlayerName" required>
                            </div>
                            <div class="form-group">
                                <label>Team/Club</label>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <select id="uploadPlayerTeam" onchange="handleClubSelect(this)" style="flex:1;">
                                        <option value="">Select Club</option>
                                    </select>
                                    <div id="clubIconDisplay" style="width:30px; height:30px;"></div>
                                </div>
                                <input type="text" id="uploadPlayerTeamCustom" placeholder="Or enter custom club name" style="margin-top: 10px; display: none;">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Card Type</label>
                                <select id="uploadCardType" onchange="handleTypeSelect(this)">
                                    <option value="">Select Type</option>
                                </select>
                                <input type="text" id="uploadCardTypeCustom" placeholder="Or enter custom type" style="margin-top: 10px; display: none;">
                            </div>
                            <div class="form-group">
                                <label>Card Company</label>
                                <select id="uploadCardCompany" required>
                                    <option value="">Select Company</option>
                                    <option value="Topps Match Attax">Topps Match Attax</option>
                                    <option value="Premier League">Premier League</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Tags (comma separated)</label>
                            <input type="text" id="uploadTags" placeholder="e.g., halloffame, rookie, limited">
                            <small style="color: #999;">Optional: Add tags like 'halloffame', 'rookie', 'limited', etc.</small>
                        </div>

                        <div class="form-group">
                            <label>Mark this card as:</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="uploadLike">
                                    <label for="uploadLike">‚ù§Ô∏è Love it</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="uploadOwn" onchange="handleOwnWantToggle('own')">
                                    <label for="uploadOwn">üí™ Own it</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="uploadWant" onchange="handleOwnWantToggle('want')">
                                    <label for="uploadWant">ü§≤ Want it</label>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn">Submit Card for Approval (Earn 1 FlipCoin!)</button>
                    </form>
                </div>
            </div>

            <!-- Your Cards Tab -->
            <div id="yourCardsTab" class="tab-content">
                <div class="stats-badge" style="margin-bottom: 20px;">
                    üì§ Cards Uploaded: <span id="uploadedCount">0</span> | üí∞ FlipCoins: <span id="yourCardsFlipcoins">0</span>
                </div>
                <div class="filter-section">
                    <h3 style="color: #ffaf00; margin-bottom: 15px;">Filter Your Cards</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-small action-tag liked" onclick="filterYourCards('liked')">‚ù§Ô∏è Loved</button>
                        <button class="btn-small action-tag owned" onclick="filterYourCards('owned')">üí™ Owned</button>
                        <button class="btn-small action-tag wanted" onclick="filterYourCards('wanted')">ü§≤ Wanted</button>
                        <button class="btn-small btn-secondary" onclick="filterYourCards('all')">Show All</button>
                    </div>
                </div>
                <div id="yourCardsContent"></div>
            </div>

            <!-- Your Friends Tab -->
            <div id="friendsTab" class="tab-content">
                <div id="friendsContent"></div>
            </div>
        </div><!-- end dashboard inner -->
    </div><!-- end container -->

    <!-- Admin Page (separate full page) -->
    <div id="adminPage" class="hidden">
        <div class="container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; padding-top:20px;">
                <h2 style="color:#ff4444; font-size:1.8em;">‚öôÔ∏è Admin Panel</h2>
                <button onclick="goBackToDashboard()" style="background:#ffaf00; color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:bold; cursor:pointer; font-size:1em;">‚Üê Back to FlipSid</button>
            </div>

            <div class="admin-nav">
                <div class="admin-tab active" onclick="switchAdminTab('users')">üë• Users</div>
                <div class="admin-tab" onclick="switchAdminTab('cards')">üé¥ Cards</div>
                <div class="admin-tab" onclick="switchAdminTab('manageClubs')">‚öΩ Clubs</div>
                <div class="admin-tab" onclick="switchAdminTab('manageTypes')">üè∑Ô∏è Card Types</div>
                <div class="admin-tab" id="superAdminTab" style="display:none;" onclick="switchAdminTab('superAdmin')">üëë Super Admin</div>
            </div>

            <!-- Users Tab -->
            <div id="adminTab-users" class="admin-tab-content active">
                <div class="admin-panel" style="margin:0;">
                    <h3>üë• All Users</h3>
                    <input type="text" id="userSearchInput" placeholder="üîç Search by nickname or name..." 
                        oninput="renderAdminUsers()"
                        style="width:100%; padding:12px; border:2px solid #ffd93d; border-radius:8px; font-size:1em; margin-bottom:20px;">
                    <div id="adminUsersList"></div>
                </div>
            </div>

            <!-- Cards Tab -->
            <div id="adminTab-cards" class="admin-tab-content">
                <div class="admin-panel" style="margin:0;">
                    <h3>üé¥ All Cards</h3>
                    <input type="text" id="cardSearchInput" placeholder="üîç Search by player name or team..."
                        oninput="renderAdminCards()"
                        style="width:100%; padding:12px; border:2px solid #ffd93d; border-radius:8px; font-size:1em; margin-bottom:20px;">
                    <div id="adminCardsList"></div>
                </div>
            </div>

            <!-- Manage Clubs -->
            <div id="adminTab-manageClubs" class="admin-tab-content">
                <div class="admin-panel" style="margin:0;">
                    <h3>‚öΩ Manage Approved Clubs</h3>
                    <div style="margin-bottom:20px;">
                        <div style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap; align-items:flex-end;">
                            <div style="flex:1; min-width:200px;">
                                <label style="display:block; margin-bottom:5px; color:#666;">Club Name</label>
                                <input type="text" id="newClubName" placeholder="e.g. Manchester City" style="width:100%; padding:10px; border:2px solid #ffd93d; border-radius:8px;">
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:5px; color:#666;">Club Logo</label>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <div id="newClubIconPreview" style="width:40px; height:40px; border:2px dashed #ffd93d; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:0.8em; color:#999;">Logo</div>
                                    <button type="button" class="btn-small" onclick="document.getElementById('newClubIconInput').click()">Choose</button>
                                    <input type="file" id="newClubIconInput" accept="image/*" style="display:none;" onchange="previewClubIcon(this, 'newClubIconPreview')">
                                </div>
                            </div>
                            <button class="btn-approve" onclick="addClub()">Add Club</button>
                        </div>
                    </div>
                    <div id="clubsList"></div>
                </div>
            </div>

            <!-- Manage Card Types -->
            <div id="adminTab-manageTypes" class="admin-tab-content">
                <div class="admin-panel" style="margin:0;">
                    <h3>üè∑Ô∏è Manage Approved Card Types</h3>
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <input type="text" id="newCardType" placeholder="e.g., Rookie, Legend, Icon" style="flex:1; padding:10px; border:2px solid #ffd93d; border-radius:8px;">
                        <button class="btn-approve" onclick="addCardType()">Add Type</button>
                    </div>
                    <div id="typesList"></div>
                </div>
            </div>

            <!-- Super Admin -->
            <div id="adminTab-superAdmin" class="admin-tab-content">
                <div class="admin-panel" style="margin:0; border-color:#9C27B0;">
                    <h3 style="color:#9C27B0;">üëë Super Admin - Manage Admins</h3>
                    <div style="margin-bottom:20px;">
                        <h4 style="color:#666; margin-bottom:10px;">Promote User to Admin</h4>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <input type="text" id="searchUserNickname" placeholder="Search by nickname..." style="flex:1; min-width:150px; padding:10px; border:2px solid #ffd93d; border-radius:8px;">
                            <button class="btn-small" onclick="searchAndPromoteUser()" style="width:auto; flex:none;">Search & Promote</button>
                        </div>
                    </div>
                    <h4 style="color:#666; margin-bottom:10px;">Current Admins</h4>
                    <div id="adminsList"></div>
                </div>
            </div>
        </div>
    </div><!-- end adminPage -->

    <!-- Image Zoom Modal -->
    <div id="imageModal" class="modal" onclick="closeModal()">
        <span class="modal-close">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <!-- Edit Card Modal -->
    <div id="editModal" class="modal">
        <div class="edit-modal-content">
            <h2 style="color: #ffaf00; margin-bottom: 20px;">Edit Card</h2>
            <form id="editCardForm">
                <input type="hidden" id="editCardId">
                <div class="form-group">
                    <label>Player Name</label>
                    <input type="text" id="editPlayerName" required>
                </div>
                <div class="form-group">
                    <label>Team/Club</label>
                    <input type="text" id="editPlayerTeam" required>
                </div>
                <div class="form-group">
                    <label>Card Type</label>
                    <input type="text" id="editCardType" required>
                </div>
                <div class="form-group">
                    <label>Card Company</label>
                    <select id="editCardCompany" required>
                        <option value="Topps Match Attax">Topps Match Attax</option>
                        <option value="Premier League">Premier League</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Club Icon</label>
                    <input type="text" id="editClubIcon">
                </div>
                <div class="form-group">
                    <label>Tags (comma separated)</label>
                    <input type="text" id="editTags">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn" onclick="saveEditedCard()">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User List Modal -->
    <div id="userListModal" class="modal" onclick="closeUserListModal()">
        <div class="edit-modal-content" onclick="event.stopPropagation()">
            <h2 style="color: #ffaf00; margin-bottom: 20px;" id="userListTitle">Users</h2>
            <div id="userListContent" style="max-height: 400px; overflow-y: auto;"></div>
            <button class="btn" onclick="closeUserListModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal">
        <div class="edit-modal-content">
            <h2 style="color: #ffaf00; margin-bottom: 20px;">Edit Profile</h2>
            <form id="editProfileForm">
                <div class="form-group">
                    <label>Profile Picture</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <img id="editProfileCurrentPic" style="width:60px; height:60px; border-radius:50%; object-fit:cover; display:none;">
                        <div class="profile-pic-placeholder" id="editProfilePicPlaceholder" style="width:60px; height:60px; cursor:pointer;">üì∑</div>
                        <button type="button" class="btn-small" onclick="document.getElementById('editProfilePicInput').click()">Choose Photo</button>
                    </div>
                    <input type="file" id="editProfilePicInput" accept="image/*" style="display:none;" onchange="previewProfilePic(this, 'editProfileCurrentPic', 'editProfilePicPlaceholder')">
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="editProfileFullName" required>
                </div>
                <div class="form-group">
                    <label>Nickname</label>
                    <input type="text" id="editProfileNickname" required>
                </div>
                <div class="form-group">
                    <label>Mobile</label>
                    <input type="text" id="editProfileMobile" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label>New Password (leave blank to keep current)</label>
                    <input type="password" id="editProfilePassword" placeholder="Min 4 characters">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn" onclick="saveProfile()">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditProfile()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="userProfileModal" class="modal" onclick="closeUserProfile()">
        <div class="edit-modal-content" onclick="event.stopPropagation()" style="max-width: 900px; width: 95%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img id="viewUserProfilePic" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; display: none;">
                    <div id="viewUserProfilePlaceholder" class="user-avatar" style="width: 60px; height: 60px; font-size: 1.5em;"></div>
                    <div>
                        <h2 style="color: #ffaf00; margin: 0;" id="viewUserNickname"></h2>
                        <div style="color: #999; margin-top: 5px;" id="viewUserStats"></div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="closeUserProfile()">Close</button>
            </div>
            
            <div class="filter-section">
                <h3 style="color: #ffaf00; margin-bottom: 15px;">Filter Cards</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-small action-tag liked" onclick="filterUserCards('liked')">‚ù§Ô∏è Loved</button>
                    <button class="btn-small action-tag owned" onclick="filterUserCards('owned')">üí™ Owned</button>
                    <button class="btn-small action-tag wanted" onclick="filterUserCards('wanted')">ü§≤ Wanted</button>
                    <button class="btn-small btn-secondary" onclick="filterUserCards('all')">Show All</button>
                </div>
            </div>

            <div id="userProfileCards" style="max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        // ============================================================
        // FIREBASE CONFIG
        // ============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAQiIbHoTyddxVdoT0UlgSp9P9mqQDYFbg",
            authDomain: "flipsid-1f16d.firebaseapp.com",
            projectId: "flipsid-1f16d",
            storageBucket: "flipsid-1f16d.firebasestorage.app",
            messagingSenderId: "735082941063",
            appId: "1:735082941063:web:567c8bbbb04b5bd22d0622",
            measurementId: "G-F2PNQMH1YF"
        };

        let db = null;
        let useFirebase = false;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            useFirebase = true;
            console.log('‚úÖ Firebase initialized');
        } catch(e) {
            console.log('‚ùå Firebase init error:', e);
        }

        // ============================================================
        // IMAGE COMPRESSION - 600px, 70% JPEG quality
        // ============================================================
        function compressImage(dataUrl) {
            return new Promise((resolve) => {
                if (!dataUrl || !dataUrl.startsWith('data:image')) { resolve(dataUrl); return; }
                const img = new Image();
                img.onload = () => {
                    const MAX = 600;
                    let w = img.width, h = img.height;
                    if (w > MAX || h > MAX) {
                        if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
                        else       { w = Math.round(w * MAX / h); h = MAX; }
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.onerror = () => resolve(dataUrl);
                img.src = dataUrl;
            });
        }

        // ============================================================
        // FIRESTORE DATA LAYER
        // New structure: individual documents per record
        //   users/{userId}
        //   cards/{cardId}
        //   pendingCards/{cardId}
        //   interactions/{cardId}
        //   follows/{userId}
        //   meta/approvedClubs
        //   meta/approvedTypes
        // ============================================================

        let currentUser = null;
        let users = [];
        let cards = [];
        let cardInteractions = {};
        let pendingCards = [];
        let follows = {};
        let followRequests = {};
        let approvedClubs = [];
        let approvedTypes = [];
        let currentYourCardsFilter = 'all';

        // ‚îÄ‚îÄ READ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function loadAllData() {
            const statusEl = document.getElementById('firebaseStatus');
            if (!useFirebase) {
                if (statusEl) statusEl.innerHTML = '‚ö†Ô∏è Offline mode';
                loadFromLocalStorage();
                return;
            }
            try {
                if (statusEl) statusEl.innerHTML = 'üîÑ Connecting...';

                const [usersSnap, cardsSnap, pendingSnap, interactionsSnap,
                       followsSnap, clubsDoc, typesDoc] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('cards').get(),
                    db.collection('pendingCards').get(),
                    db.collection('interactions').get(),
                    db.collection('follows').get(),
                    db.collection('meta').doc('approvedClubs').get(),
                    db.collection('meta').doc('approvedTypes').get()
                ]);

                users            = usersSnap.docs.map(d => d.data());
                cards            = cardsSnap.docs.map(d => d.data());
                pendingCards     = pendingSnap.docs.map(d => d.data());
                cardInteractions = {};
                interactionsSnap.docs.forEach(d => { cardInteractions[d.id] = d.data(); });
                follows          = {};
                followsSnap.docs.forEach(d => { follows[d.id] = d.data(); });
                approvedClubs    = clubsDoc.exists  ? clubsDoc.data().list  : [];
                approvedTypes    = typesDoc.exists  ? typesDoc.data().list  : [];
                followRequests   = buildFollowRequests();

                // Cache to localStorage
                cacheToLocal();

                if (statusEl) { statusEl.innerHTML = 'üî• Firebase connected'; setTimeout(() => statusEl.style.display='none', 3000); }
                console.log(`‚úÖ Loaded: ${users.length} users, ${cards.length} cards, ${pendingCards.length} pending`);
            } catch(e) {
                console.log('‚ùå Firebase load error:', e);
                if (statusEl) statusEl.innerHTML = '‚ùå Firebase error';
                loadFromLocalStorage();
            }
        }

        function buildFollowRequests() {
            // followRequests[targetId] = [requesterId, ...]
            const fr = {};
            Object.keys(follows).forEach(uid => {
                const fdata = follows[uid];
                if (fdata.requests) {
                    fdata.requests.forEach(targetId => {
                        if (!fr[targetId]) fr[targetId] = [];
                        fr[targetId].push(parseInt(uid));
                    });
                }
            });
            return fr;
        }

        function cacheToLocal() {
            localStorage.setItem('flipsidUsers',            JSON.stringify(users));
            localStorage.setItem('flipsidCards',            JSON.stringify(cards));
            localStorage.setItem('flipsidPendingCards',     JSON.stringify(pendingCards));
            localStorage.setItem('flipsidCardInteractions', JSON.stringify(cardInteractions));
            localStorage.setItem('flipsidFollows',          JSON.stringify(follows));
            localStorage.setItem('flipsidApprovedClubs',    JSON.stringify(approvedClubs));
            localStorage.setItem('flipsidApprovedTypes',    JSON.stringify(approvedTypes));
        }

        function loadFromLocalStorage() {
            users            = JSON.parse(localStorage.getItem('flipsidUsers'))            || [];
            cards            = JSON.parse(localStorage.getItem('flipsidCards'))            || [];
            pendingCards     = JSON.parse(localStorage.getItem('flipsidPendingCards'))     || [];
            cardInteractions = JSON.parse(localStorage.getItem('flipsidCardInteractions')) || {};
            follows          = JSON.parse(localStorage.getItem('flipsidFollows'))          || {};
            approvedClubs    = JSON.parse(localStorage.getItem('flipsidApprovedClubs'))    || [];
            approvedTypes    = JSON.parse(localStorage.getItem('flipsidApprovedTypes'))    || [];
            followRequests   = buildFollowRequests();
        }

        // ‚îÄ‚îÄ WRITE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function saveUser(user) {
            const id = String(user.id);
            localStorage.setItem('flipsidUsers', JSON.stringify(users));
            if (!useFirebase) return;
            try { await db.collection('users').doc(id).set(user); }
            catch(e) { console.log('saveUser error:', e); }
        }

        async function saveCard(card) {
            const id = String(card.id);
            // Update in-memory cards array
            const idx = cards.findIndex(c => String(c.id) === id);
            if (idx >= 0) cards[idx] = card; else cards.push(card);
            localStorage.setItem('flipsidCards', JSON.stringify(cards));
            if (!useFirebase) return;
            try { await db.collection('cards').doc(id).set(card); }
            catch(e) { console.log('saveCard error:', e); }
        }

        async function deleteCardFromDB(cardId) {
            const id = String(cardId);
            cards = cards.filter(c => String(c.id) !== id);
            delete cardInteractions[cardId];
            localStorage.setItem('flipsidCards', JSON.stringify(cards));
            localStorage.setItem('flipsidCardInteractions', JSON.stringify(cardInteractions));
            if (!useFirebase) return;
            try {
                await Promise.all([
                    db.collection('cards').doc(id).delete(),
                    db.collection('interactions').doc(id).delete()
                ]);
            } catch(e) { console.log('deleteCard error:', e); }
        }

        async function savePendingCard(card) {
            const id = String(card.id);
            const idx = pendingCards.findIndex(c => String(c.id) === id);
            if (idx >= 0) pendingCards[idx] = card; else pendingCards.push(card);
            localStorage.setItem('flipsidPendingCards', JSON.stringify(pendingCards));
            if (!useFirebase) return;
            try { await db.collection('pendingCards').doc(id).set(card); }
            catch(e) { console.log('savePendingCard error:', e); }
        }

        async function deletePendingCard(cardId) {
            const id = String(cardId);
            pendingCards = pendingCards.filter(c => String(c.id) !== id);
            localStorage.setItem('flipsidPendingCards', JSON.stringify(pendingCards));
            if (!useFirebase) return;
            try { await db.collection('pendingCards').doc(id).delete(); }
            catch(e) { console.log('deletePendingCard error:', e); }
        }

        async function saveInteractions(cardId, data) {
            const id = String(cardId);
            cardInteractions[id] = data;
            localStorage.setItem('flipsidCardInteractions', JSON.stringify(cardInteractions));
            if (!useFirebase) return;
            try { await db.collection('interactions').doc(id).set(data); }
            catch(e) { console.log('saveInteractions error:', e); }
        }

        async function saveFollows(userId, data) {
            const id = String(userId);
            follows[id] = data;
            followRequests = buildFollowRequests();
            localStorage.setItem('flipsidFollows', JSON.stringify(follows));
            if (!useFirebase) return;
            try { await db.collection('follows').doc(id).set(data); }
            catch(e) { console.log('saveFollows error:', e); }
        }

        async function saveMeta() {
            localStorage.setItem('flipsidApprovedClubs', JSON.stringify(approvedClubs));
            localStorage.setItem('flipsidApprovedTypes', JSON.stringify(approvedTypes));
            if (!useFirebase) return;
            try {
                await Promise.all([
                    db.collection('meta').doc('approvedClubs').set({ list: approvedClubs }),
                    db.collection('meta').doc('approvedTypes').set({ list: approvedTypes })
                ]);
            } catch(e) { console.log('saveMeta error:', e); }
        }

        // ============================================================
        // AUTH
        // ============================================================

        function togglePasswordVisibility(inputId, eyeId) {
            const input = document.getElementById(inputId);
            const eye = document.getElementById(eyeId);
            if (input.type === 'password') { input.type = 'text'; eye.textContent = 'üôà'; }
            else { input.type = 'password'; eye.textContent = 'üëÅÔ∏è'; }
        }

        function checkAuth() {
            const stored = localStorage.getItem('flipsidCurrentUser');
            if (stored) {
                const saved = JSON.parse(stored);
                // Refresh from latest users array
                const fresh = users.find(u => String(u.id) === String(saved.id));
                currentUser = fresh || saved;
                if (!currentUser.approved) { showPendingApproval(); return; }
                showDashboard();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('pendingApproval').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('authButtons').classList.remove('hidden');
            document.getElementById('userSection').classList.add('hidden');
        }

        function showSignup() {
            document.getElementById('signupForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('pendingApproval').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('authButtons').classList.remove('hidden');
            document.getElementById('userSection').classList.add('hidden');
        }

        function showPendingApproval() {
            document.getElementById('pendingApproval').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('authButtons').classList.add('hidden');
            document.getElementById('userSection').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('pendingApproval').classList.add('hidden');
            document.getElementById('authButtons').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');

            document.getElementById('userName').textContent = currentUser.nickname;
            document.getElementById('headerFlipcoins').textContent = currentUser.flipcoins || 0;

            if (currentUser.profilePic) {
                document.getElementById('userProfilePic').src = currentUser.profilePic;
                document.getElementById('userProfilePic').style.display = 'block';
                document.getElementById('userAvatar').style.display = 'none';
            } else {
                document.getElementById('userAvatar').textContent = currentUser.nickname.charAt(0).toUpperCase();
                document.getElementById('userProfilePic').style.display = 'none';
                document.getElementById('userAvatar').style.display = 'flex';
            }

            if (currentUser.isAdmin) {
                document.getElementById('adminBadge').classList.remove('hidden');
                document.getElementById('adminPageBtn').classList.remove('hidden');
            } else {
                document.getElementById('adminBadge').classList.add('hidden');
                document.getElementById('adminPageBtn').classList.add('hidden');
            }

            populateClubsDropdown();
            populateTypesDropdown();
            updateFilterOptions();
            loadBrowseCards();
            updateFollowRequestBadge();
        }

        function showAdminPage() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('adminPage').classList.remove('hidden');
            if (currentUser.isSuperAdmin) {
                document.getElementById('superAdminTab').style.display = 'block';
                loadAdminsList();
            }
            loadClubsList();
            loadTypesList();
            renderAdminUsers();
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.admin-tab').classList.add('active');
            document.getElementById('adminTab-users').classList.add('active');
        }

        function goBackToDashboard() {
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function switchAdminTab(tabName) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`adminTab-${tabName}`).classList.add('active');
            if (tabName === 'users') renderAdminUsers();
            if (tabName === 'cards') renderAdminCards();
        }

        function login(e) {
            e.preventDefault();
            const nickname = document.getElementById('loginNickname').value.trim();
            const password = document.getElementById('loginPassword').value;
            const user = users.find(u => u.nickname === nickname && u.password === password);
            if (user) {
                if (!user.approved) {
                    currentUser = user;
                    localStorage.setItem('flipsidCurrentUser', JSON.stringify(user));
                    showPendingApproval();
                    return;
                }
                currentUser = user;
                localStorage.setItem('flipsidCurrentUser', JSON.stringify(user));
                showDashboard();
            } else {
                document.getElementById('loginError').textContent = 'Wrong nickname or password!';
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function signup(e) {
            e.preventDefault();
            const fullName = document.getElementById('signupFullName').value.trim();
            const nickname = document.getElementById('signupNickname').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirm  = document.getElementById('signupConfirmPassword').value;
            const errorEl  = document.getElementById('signupError');

            if (password !== confirm) { errorEl.textContent = 'Passwords do not match!'; errorEl.style.display='block'; return; }
            if (password.length < 4)  { errorEl.textContent = 'Password must be at least 4 characters!'; errorEl.style.display='block'; return; }
            if (users.find(u => u.nickname === nickname)) { errorEl.textContent = 'Nickname already taken!'; errorEl.style.display='block'; return; }

            const newUser = {
                id: Date.now(),
                fullName, nickname, password,
                isAdmin: false, isSuperAdmin: false,
                approved: false, flipcoins: 0, profilePic: null
            };
            users.push(newUser);
            saveUser(newUser);
            currentUser = newUser;
            localStorage.setItem('flipsidCurrentUser', JSON.stringify(newUser));
            showPendingApproval();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('flipsidCurrentUser');
            showLogin();
        }

        // ============================================================
        // TABS
        // ============================================================

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            if (tab === 'browse')    { updateFilterOptions(); loadBrowseCards(); }
            if (tab === 'yourCards') loadYourCards();
            if (tab === 'friends')   loadFriends();
        }

        // ============================================================
        // IMAGE PREVIEW
        // ============================================================

        function previewImage(input, previewId) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById(previewId);
                preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">`;
                preview.dataset.imageData = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function previewProfilePic(input, imgId, placeholderId) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById(imgId).src = e.target.result;
                document.getElementById(imgId).style.display = 'block';
                if (placeholderId) document.getElementById(placeholderId).style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        // ============================================================
        // UPLOAD CARD
        // ============================================================

        async function uploadCard(e) {
            e.preventDefault();
            const playerName = document.getElementById('uploadPlayerName').value.trim();
            
            // Check if custom team or selected team
            const teamSelect = document.getElementById('uploadPlayerTeam').value;
            const teamCustom = document.getElementById('uploadPlayerTeamCustom').value.trim();
            const team = teamSelect === '__custom__' ? teamCustom : teamSelect;
            
            const clubIconEl = document.getElementById('clubIconDisplay');
            const clubIcon   = clubIconEl ? (clubIconEl.dataset.icon || '') : '';
            
            // Check if custom type or selected type
            const typeSelect = document.getElementById('uploadCardType').value;
            const typeCustom = document.getElementById('uploadCardTypeCustom').value.trim();
            const cardType = typeSelect === '__custom__' ? typeCustom : typeSelect;
            
            const company    = document.getElementById('uploadCardCompany').value.trim();
            const tagsInput  = document.getElementById('uploadTags').value.trim();
            const tags       = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(Boolean) : [];

            const frontPreview = document.getElementById('uploadFrontPreview');
            const backPreview  = document.getElementById('uploadBackPreview');
            const frontRaw = frontPreview?.querySelector('img')?.src || null;
            const backRaw  = backPreview?.querySelector('img')?.src || null;

            if (!playerName || !team || !cardType || !company) {
                alert('Please fill in all required fields!'); return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.textContent = '‚è≥ Compressing & uploading...';
            submitBtn.disabled = true;

            try {
                // Compress images
                const [frontImage, backImage] = await Promise.all([
                    compressImage(frontRaw),
                    compressImage(backRaw)
                ]);

                const card = {
                    id: Date.now(),
                    playerName, team, clubIcon, cardType, company, tags,
                    frontImage, backImage,
                    uploadedBy: currentUser.id,
                    uploaderNickname: currentUser.nickname,
                    createdAt: new Date().toISOString(),
                    approved: false,
                    userInteractions: {
                        like: document.getElementById('uploadLike')?.checked || false,
                        own:  document.getElementById('uploadOwn')?.checked  || false,
                        want: document.getElementById('uploadWant')?.checked  || false
                    }
                };

                await savePendingCard(card);

                // Award upload FlipCoin
                currentUser.flipcoins = (currentUser.flipcoins || 0) + 1;
                const userInArray = users.find(u => String(u.id) === String(currentUser.id));
                if (userInArray) userInArray.flipcoins = currentUser.flipcoins;
                await saveUser(currentUser);
                document.getElementById('headerFlipcoins').textContent = currentUser.flipcoins;
                localStorage.setItem('flipsidCurrentUser', JSON.stringify(currentUser));

                alert('Card submitted for review! You earned 1 FlipCoin! üéâ');
                e.target.reset();
                if (frontPreview) frontPreview.innerHTML = '';
                if (backPreview) backPreview.innerHTML = '';
                if (clubIconEl) { clubIconEl.innerHTML = ''; clubIconEl.dataset.icon = ''; }
            } catch(err) {
                console.error('Upload error:', err);
                alert('Upload failed, please try again.');
            } finally {
                submitBtn.textContent = 'Submit Card for Review';
                submitBtn.disabled = false;
            }
        }

        // ============================================================
        // BROWSE CARDS
        // ============================================================

        function loadBrowseCards() {
            const container = document.getElementById('browseContent');
            const approved = cards.filter(c => c.approved !== false);
            if (approved.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üé¥</div><h3>No cards yet</h3><p>Be the first to upload a card!</p></div>`;
                return;
            }
            container.innerHTML = `<div class="cards-grid">${approved.map(c => renderCard(c)).join('')}</div>`;
        }

        function applyFilters() {
            const search   = document.getElementById('searchText')?.value.toLowerCase() || '';
            const clubF    = document.getElementById('filterTeam')?.value || '';
            const typeF    = document.getElementById('filterType')?.value || '';
            const companyF = document.getElementById('filterCompany')?.value || '';

            let filtered = cards.filter(c => c.approved !== false);

            if (search) filtered = filtered.filter(c =>
                c.playerName.toLowerCase().includes(search) ||
                c.team.toLowerCase().includes(search) ||
                c.company.toLowerCase().includes(search));
            if (clubF) filtered = filtered.filter(c => c.team === clubF);
            if (typeF) filtered = filtered.filter(c => c.cardType === typeF);
            if (companyF) filtered = filtered.filter(c => c.company === companyF);

            const container = document.getElementById('browseContent');
            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üîç</div><h3>No cards match</h3><p>Try different filters</p></div>`;
                return;
            }
            container.innerHTML = `<div class="cards-grid">${filtered.map(c => renderCard(c)).join('')}</div>`;
        }

        function clearFilters() {
            if (document.getElementById('searchText')) document.getElementById('searchText').value = '';
            if (document.getElementById('filterTeam')) document.getElementById('filterTeam').value = '';
            if (document.getElementById('filterType')) document.getElementById('filterType').value = '';
            if (document.getElementById('filterCompany')) document.getElementById('filterCompany').value = '';
            loadBrowseCards();
        }


        // ============================================================
        // RENDER CARD
        // ============================================================

        function renderCard(card, showActions = true) {
            const id  = String(card.id);
            const ix  = cardInteractions[id] || cardInteractions[card.id] || { likes:[], owns:[], wants:[] };
            const uid = String(currentUser.id);
            const liked  = ix.likes  ? ix.likes.map(String).includes(uid)  : false;
            const owned  = ix.owns   ? ix.owns.map(String).includes(uid)   : false;
            const wanted = ix.wants  ? ix.wants.map(String).includes(uid)  : false;

            const tagsHtml = card.tags && card.tags.length > 0
                ? '<div class="tags">' + card.tags.map(t => `<span class="tag ${t.toLowerCase()}">${t}</span>`).join('') + '</div>' : '';
            const editBtn = currentUser.isAdmin
                ? `<button class="btn-edit-card" onclick="editApprovedCard(${card.id})">‚úèÔ∏è</button>` : '';
            const uploaderHtml = currentUser.isAdmin && card.uploaderNickname
                ? `<div class="uploader-badge">‚¨ÜÔ∏è ${card.uploaderNickname}</div>` : '';

            return `
                <div class="card-item">
                    <div class="card-id-badge">#${card.id}</div>
                    <div class="card-images">
                        <div class="card-image" onclick="openModal('${card.frontImage || ''}')">
                            ${card.frontImage ? `<img src="${card.frontImage}" alt="Front">` : `${card.playerName}<br>FRONT`}
                        </div>
                        <div class="card-image" onclick="openModal('${card.backImage || ''}')">
                            ${card.backImage ? `<img src="${card.backImage}" alt="Back">` : `${card.playerName}<br>BACK`}
                        </div>
                    </div>
                    <div class="card-info">
                        <div class="card-title-row">
                            <h3>${card.playerName}</h3>
                            <div class="card-title-actions">
                                <span class="heart-icon ${liked ? 'liked' : ''}" onclick="toggleLike(${card.id})">
                                    ${liked ? '‚ù§Ô∏è' : 'ü§ç'} <span class="heart-count" onclick="event.stopPropagation();showUserList(${card.id},'likes')">${ix.likes ? ix.likes.length : 0}</span>
                                </span>
                                ${editBtn}
                            </div>
                        </div>
                        <div class="card-detail"><strong>Team:</strong><span>${card.team} ${card.clubIcon ? `<img src="${card.clubIcon}" style="width:20px;height:20px;border-radius:4px;object-fit:cover;margin-left:4px;vertical-align:middle;">` : ''}</span></div>
                        <div class="card-detail"><strong>Type:</strong><span>${card.cardType}</span></div>
                        <div class="card-detail"><strong>Company:</strong><span>${card.company}</span></div>
                        ${tagsHtml}
                        <div class="interaction-counters">
                            <div class="interaction-counter owns"  onclick="showUserList(${card.id},'owns')">üí™ ${ix.owns  ? ix.owns.length  : 0} owners</div>
                            <div class="interaction-counter wants" onclick="showUserList(${card.id},'wants')">ü§≤ ${ix.wants ? ix.wants.length : 0} wanting</div>
                        </div>
                        ${uploaderHtml}
                    </div>
                    ${showActions ? `
                    <div class="card-actions">
                        <button class="btn-small ${owned  ? 'btn-active' : ''}" onclick="toggleOwn(${card.id})"  ${wanted ? 'disabled style="opacity:0.4;"' : ''}>
                            ${owned  ? 'üí™ Own ‚úì' : 'üí™ Own'}
                        </button>
                        <button class="btn-small ${wanted ? 'btn-active' : ''}" onclick="toggleWant(${card.id})" ${owned  ? 'disabled style="opacity:0.4;"' : ''}>
                            ${wanted ? 'ü§≤ Want ‚úì' : 'ü§≤ Want'}
                        </button>
                    </div>` : ''}
                </div>`;
        }

        // ============================================================
        // INTERACTIONS ‚Äî Love / Own / Want
        // ============================================================

        async function toggleLike(cardId) {
            const id  = String(cardId);
            const ix  = cardInteractions[id] || cardInteractions[cardId] || { likes:[], owns:[], wants:[] };
            const uid = String(currentUser.id);
            if (!ix.likes) ix.likes = [];
            const idx = ix.likes.map(String).indexOf(uid);
            if (idx >= 0) ix.likes.splice(idx, 1); else ix.likes.push(uid);
            await saveInteractions(cardId, ix);
            loadBrowseCards();
        }

        async function toggleOwn(cardId) {
            const id  = String(cardId);
            const ix  = cardInteractions[id] || cardInteractions[cardId] || { likes:[], owns:[], wants:[] };
            const uid = String(currentUser.id);
            if (!ix.owns)  ix.owns  = [];
            if (!ix.wants) ix.wants = [];
            if (ix.wants.map(String).includes(uid)) return; // mutually exclusive
            const idx = ix.owns.map(String).indexOf(uid);
            if (idx >= 0) ix.owns.splice(idx, 1); else ix.owns.push(uid);
            await saveInteractions(cardId, ix);
            loadBrowseCards();
        }

        async function toggleWant(cardId) {
            const id  = String(cardId);
            const ix  = cardInteractions[id] || cardInteractions[cardId] || { likes:[], owns:[], wants:[] };
            const uid = String(currentUser.id);
            if (!ix.owns)  ix.owns  = [];
            if (!ix.wants) ix.wants = [];
            if (ix.owns.map(String).includes(uid)) return; // mutually exclusive
            const idx = ix.wants.map(String).indexOf(uid);
            if (idx >= 0) ix.wants.splice(idx, 1); else ix.wants.push(uid);
            await saveInteractions(cardId, ix);
            loadBrowseCards();
        }

        // ============================================================
        // YOUR CARDS
        // ============================================================

        function loadYourCards() {
            const container = document.getElementById('yourCardsContent');
            const filter = currentYourCardsFilter || 'all';
            const uid = String(currentUser.id);

            let myCards = [];
            if (filter === 'all' || filter === 'uploaded') {
                const uploaded = cards.filter(c => String(c.uploadedBy) === uid);
                uploaded.forEach(c => { if (!myCards.find(x => String(x.id) === String(c.id))) myCards.push({...c, _tag:'uploaded'}); });
            }
            if (filter === 'all' || filter === 'loved') {
                cards.filter(c => {
                    const ix = cardInteractions[String(c.id)] || cardInteractions[c.id] || {};
                    return ix.likes && ix.likes.map(String).includes(uid);
                }).forEach(c => { if (!myCards.find(x => String(x.id) === String(c.id))) myCards.push({...c, _tag:'loved'}); });
            }
            if (filter === 'all' || filter === 'owned') {
                cards.filter(c => {
                    const ix = cardInteractions[String(c.id)] || cardInteractions[c.id] || {};
                    return ix.owns && ix.owns.map(String).includes(uid);
                }).forEach(c => { if (!myCards.find(x => String(x.id) === String(c.id))) myCards.push({...c, _tag:'owned'}); });
            }
            if (filter === 'all' || filter === 'wanted') {
                cards.filter(c => {
                    const ix = cardInteractions[String(c.id)] || cardInteractions[c.id] || {};
                    return ix.wants && ix.wants.map(String).includes(uid);
                }).forEach(c => { if (!myCards.find(x => String(x.id) === String(c.id))) myCards.push({...c, _tag:'wanted'}); });
            }

            if (myCards.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üíù</div><h3>No cards here yet</h3><p>Upload a card or interact with cards to see them here!</p></div>`;
                return;
            }
            container.innerHTML = `<div class="cards-grid">${myCards.map(c => renderCardWithTags(c)).join('')}</div>`;
        }

        function filterYourCards(filter) {
            currentYourCardsFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            loadYourCards();
        }

        function renderCardWithTags(card) {
            const ix  = cardInteractions[String(card.id)] || cardInteractions[card.id] || { likes:[], owns:[], wants:[] };
            const uid = String(currentUser.id);
            const actionTags = [];
            if (String(card.uploadedBy) === uid) actionTags.push('<span class="tag" style="background:#ffd93d;color:#333;">‚¨ÜÔ∏è Uploaded</span>');
            if (ix.likes  && ix.likes.map(String).includes(uid))  actionTags.push('<span class="tag" style="background:#ff4d4d;color:white;">‚ù§Ô∏è Loved</span>');
            if (ix.owns   && ix.owns.map(String).includes(uid))   actionTags.push('<span class="tag" style="background:#4CAF50;color:white;">üí™ Own</span>');
            if (ix.wants  && ix.wants.map(String).includes(uid))  actionTags.push('<span class="tag" style="background:#2196F3;color:white;">ü§≤ Want</span>');
            const actionTagsHtml = actionTags.length > 0 ? `<div class="tags" style="margin-top:8px;">${actionTags.join('')}</div>` : '';

            return `
                <div class="card-item">
                    <div class="card-id-badge">#${card.id}</div>
                    <div class="card-images">
                        <div class="card-image" onclick="openModal('${card.frontImage || ''}')">
                            ${card.frontImage ? `<img src="${card.frontImage}" alt="Front">` : `${card.playerName}<br>FRONT`}
                        </div>
                        <div class="card-image" onclick="openModal('${card.backImage || ''}')">
                            ${card.backImage ? `<img src="${card.backImage}" alt="Back">` : `${card.playerName}<br>BACK`}
                        </div>
                    </div>
                    <div class="card-info">
                        <h3>${card.playerName}</h3>
                        <div class="card-detail"><strong>Team:</strong><span>${card.team} ${card.clubIcon ? `<img src="${card.clubIcon}" style="width:18px;height:18px;border-radius:3px;object-fit:cover;vertical-align:middle;">` : ''}</span></div>
                        <div class="card-detail"><strong>Type:</strong><span>${card.cardType}</span></div>
                        <div class="card-detail"><strong>Company:</strong><span>${card.company}</span></div>
                        ${actionTagsHtml}
                    </div>
                </div>`;
        }

        // ============================================================
        // ADMIN ‚Äî USERS TAB
        // ============================================================

        function renderAdminUsers() {
            const search = (document.getElementById('userSearchInput')?.value || '').toLowerCase();
            const container = document.getElementById('adminUsersList');
            const filtered = users
                .filter(u => !u.isSuperAdmin)
                .filter(u => !search || u.nickname.toLowerCase().includes(search) || u.fullName.toLowerCase().includes(search))
                .sort((a, b) => {
                    if (!a.approved && b.approved) return -1;
                    if (a.approved && !b.approved) return 1;
                    return a.nickname.localeCompare(b.nickname);
                });

            if (filtered.length === 0) { container.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">No users found</p>'; return; }

            container.innerHTML = filtered.map(user => {
                const isPending = !user.approved;
                return `
                <div class="admin-user-row ${isPending ? 'pending-highlight' : ''}">
                    <div class="admin-user-info">
                        <div style="display:flex;align-items:center;gap:10px;">
                            ${user.profilePic ? `<img src="${user.profilePic}" style="width:45px;height:45px;border-radius:50%;object-fit:cover;border:2px solid #ffd93d;">` : `<div class="user-avatar" style="width:45px;height:45px;font-size:1.2em;">${user.nickname.charAt(0).toUpperCase()}</div>`}
                            <div>
                                <div style="font-weight:bold;font-size:1.05em;">
                                    ${user.nickname}
                                    ${isPending ? '<span style="background:#FF9800;color:white;padding:2px 8px;border-radius:10px;font-size:0.75em;margin-left:6px;">‚è≥ Pending</span>' : ''}
                                    ${user.isAdmin ? '<span style="background:#ff4444;color:white;padding:2px 8px;border-radius:10px;font-size:0.75em;margin-left:6px;">ADMIN</span>' : ''}
                                </div>
                                <div style="color:#999;font-size:0.85em;margin-top:2px;">${user.fullName} ¬∑ üí∞ ${user.flipcoins || 0} FlipCoins</div>
                            </div>
                        </div>
                    </div>
                    <div class="admin-user-actions">
                        ${isPending  ? `<button class="btn-approve" onclick="approveUserAdmin(${user.id})">‚úì Approve</button>` : ''}
                        ${isPending  ? `<button class="btn-reject"  onclick="rejectUserAdmin(${user.id})">‚úó Reject</button>`  : ''}
                        ${!isPending ? `<button class="btn-edit"    onclick="openEditUserModal(${user.id})">‚úèÔ∏è Edit</button>`  : ''}
                        ${!isPending ? `<button class="btn-small"   onclick="openResetPasswordModal(${user.id})" style="background:#9C27B0;color:white;">üîë Reset</button>` : ''}
                        ${!isPending && !user.isAdmin && currentUser.isSuperAdmin ? `<button class="btn-small" onclick="makeAdmin(${user.id})" style="background:#ff4444;color:white;">‚≠ê Make Admin</button>` : ''}
                        ${!isPending && user.isAdmin && !user.isSuperAdmin && currentUser.isSuperAdmin ? `<button class="btn-small btn-secondary" onclick="removeAdminRole(${user.id})">Remove Admin</button>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        async function approveUserAdmin(userId) {
            const user = users.find(u => String(u.id) === String(userId));
            if (!user) return;
            user.approved = true;
            await saveUser(user);
            renderAdminUsers();
        }

        async function rejectUserAdmin(userId) {
            if (!confirm('Reject and delete this user?')) return;
            users = users.filter(u => String(u.id) !== String(userId));
            if (!useFirebase) { localStorage.setItem('flipsidUsers', JSON.stringify(users)); renderAdminUsers(); return; }
            try { await db.collection('users').doc(String(userId)).delete(); }
            catch(e) { console.log('rejectUser error:', e); }
            renderAdminUsers();
        }

        async function makeAdmin(userId) {
            if (!confirm('Make this user an admin?')) return;
            const user = users.find(u => String(u.id) === String(userId));
            if (!user) return;
            user.isAdmin = true;
            await saveUser(user);
            renderAdminUsers();
        }

        async function removeAdminRole(userId) {
            if (!confirm('Remove admin privileges?')) return;
            const user = users.find(u => String(u.id) === String(userId));
            if (!user) return;
            user.isAdmin = false;
            await saveUser(user);
            renderAdminUsers();
            loadAdminsList();
        }

        function openEditUserModal(userId) {
            const user = users.find(u => String(u.id) === String(userId));
            if (!user) return;
            document.getElementById('editUserModalNickname').value = user.nickname;
            document.getElementById('editUserModalFullName').value = user.fullName || '';
            document.getElementById('editUserModalMobile').value   = user.mobile || '';
            document.getElementById('editUserModalId').value = userId;
            
            if (user.profilePic) {
                document.getElementById('editUserModalPic').src = user.profilePic;
                document.getElementById('editUserModalPic').style.display = 'block';
                document.getElementById('editUserModalPicPlaceholder').style.display = 'none';
            } else {
                document.getElementById('editUserModalPic').style.display = 'none';
                document.getElementById('editUserModalPicPlaceholder').style.display = 'flex';
                document.getElementById('editUserModalPicPlaceholder').textContent = user.nickname.charAt(0).toUpperCase();
            }
            
            document.getElementById('editUserModal').classList.add('active');
        }

        async function saveEditedUser() {
            const userId      = document.getElementById('editUserModalId').value;
            const user        = users.find(u => String(u.id) === String(userId));
            if (!user) return;
            
            const newNickname = document.getElementById('editUserModalNickname').value.trim();
            const newFullName = document.getElementById('editUserModalFullName').value.trim();
            const newMobile   = document.getElementById('editUserModalMobile').value.trim();
            const picInput    = document.getElementById('editUserModalPicInput');
            
            if (!newNickname) { alert('Nickname cannot be empty'); return; }
            if (users.find(u => u.nickname === newNickname && String(u.id) !== String(userId))) { alert('Nickname already taken!'); return; }
            
            user.nickname  = newNickname;
            user.fullName  = newFullName;
            user.mobile    = newMobile;
            
            if (picInput && picInput.files[0]) {
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    user.profilePic = await compressImage(ev.target.result);
                    await saveUser(user);
                    document.getElementById('editUserModal').classList.remove('active');
                    renderAdminUsers();
                };
                reader.readAsDataURL(picInput.files[0]);
                return;
            }
            
            await saveUser(user);
            document.getElementById('editUserModal').classList.remove('active');
            renderAdminUsers();
        }

        function openResetPasswordModal(userId) {
            const user = users.find(u => String(u.id) === String(userId));
            if (!user) return;
            document.getElementById('resetPasswordUserId').value    = userId;
            document.getElementById('resetPasswordUsername').textContent = user.nickname;
            document.getElementById('resetPasswordInput').value     = '';
            document.getElementById('resetPasswordResult').innerHTML = '';
            document.getElementById('resetPasswordModal').classList.add('active');
        }

        async function saveResetPassword() {
            const userId     = document.getElementById('resetPasswordUserId').value;
            const newPassword = document.getElementById('resetPasswordInput').value.trim();
            if (!newPassword || newPassword.length < 4) { alert('Password must be at least 4 characters'); return; }
            const user = users.find(u => String(u.id) === String(userId));
            if (!user) return;
            user.password = newPassword;
            await saveUser(user);
            document.getElementById('resetPasswordResult').innerHTML = `
                <div style="background:#e8f5e9;padding:12px;border-radius:8px;border:2px solid #4CAF50;margin-top:10px;text-align:center;">
                    ‚úÖ Done! Tell <strong>${user.nickname}</strong> their new password: <strong style="color:#ff4444;">${newPassword}</strong>
                </div>`;
        }

        // ============================================================
        // ADMIN ‚Äî CARDS TAB
        // ============================================================

        function renderAdminCards() {
            const search = (document.getElementById('cardSearchInput')?.value || '').toLowerCase();
            const container = document.getElementById('adminCardsList');
            const allCards = [
                ...pendingCards.map(c => ({...c, _isPending: true})),
                ...cards.filter(c => c.approved !== false)
            ].filter(c => !search || c.playerName.toLowerCase().includes(search) || c.team.toLowerCase().includes(search));

            if (allCards.length === 0) { container.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">No cards found</p>'; return; }

            container.innerHTML = allCards.map(card => `
                <div class="admin-card-row ${card._isPending ? 'pending-highlight' : ''}">
                    <div style="display:flex;gap:8px;flex-shrink:0;">
                        <div class="card-image" style="width:65px;height:90px;font-size:0.6em;" onclick="openModal('${card.frontImage || ''}')">
                            ${card.frontImage ? `<img src="${card.frontImage}" alt="Front">` : 'FRONT'}
                        </div>
                        <div class="card-image" style="width:65px;height:90px;font-size:0.6em;" onclick="openModal('${card.backImage || ''}')">
                            ${card.backImage ? `<img src="${card.backImage}" alt="Back">` : 'BACK'}
                        </div>
                    </div>
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:bold;font-size:1.05em;">
                            ${card.playerName}
                            ${card._isPending ? '<span style="background:#FF9800;color:white;padding:2px 8px;border-radius:10px;font-size:0.75em;margin-left:6px;">‚è≥ Pending</span>' : ''}
                        </div>
                        <div style="color:#999;font-size:0.85em;margin-top:3px;">${card.team} ${card.clubIcon ? `<img src="${card.clubIcon}" style="width:18px;height:18px;border-radius:3px;object-fit:cover;vertical-align:middle;">` : ''} ¬∑ ${card.cardType} ¬∑ ${card.company}</div>
                        <div style="color:#bbb;font-size:0.8em;">‚¨ÜÔ∏è ${card.uploaderNickname || 'unknown'} ¬∑ #${card.id}</div>
                        ${card.tags && card.tags.length > 0 ? `<div class="tags" style="margin-top:4px;">${card.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>` : ''}
                    </div>
                    <div class="admin-user-actions">
                        ${card._isPending ? `<button class="btn-approve" onclick="event.stopPropagation(); approveCard(${card.id})">‚úì Approve</button>` : ''}
                        ${card._isPending ? `<button class="btn-reject"  onclick="event.stopPropagation(); rejectCard(${card.id})">‚úó Reject</button>`   : ''}
                        <button class="btn-edit" onclick="event.stopPropagation(); openEditCardModal(${card.id}, ${card._isPending || false})">‚úèÔ∏è Edit</button>
                        ${!card._isPending ? `<button class="btn-reject" onclick="event.stopPropagation(); deleteCard(${card.id})">üóëÔ∏è Delete</button>` : ''}
                    </div>
                </div>`).join('');
        }

        async function approveCard(cardId) {
            const card = pendingCards.find(c => String(c.id) === String(cardId));
            if (!card) return;

            card.approved = true;

            // Add club/type if new
            if (!approvedClubs.find(c => c.name === card.team)) approvedClubs.push({name: card.team, icon: card.clubIcon || null});
            if (!approvedTypes.includes(card.cardType)) approvedTypes.push(card.cardType);

            const ix = {
                likes: card.userInteractions?.like  ? [String(card.uploadedBy)] : [],
                owns:  card.userInteractions?.own   ? [String(card.uploadedBy)] : [],
                wants: card.userInteractions?.want  ? [String(card.uploadedBy)] : []
            };

            // Award FlipCoin to uploader
            const uploader = users.find(u => String(u.id) === String(card.uploadedBy));
            if (uploader) {
                uploader.flipcoins = (uploader.flipcoins || 0) + 1;
                if (String(currentUser.id) === String(uploader.id)) {
                    currentUser.flipcoins = uploader.flipcoins;
                    document.getElementById('headerFlipcoins').textContent = currentUser.flipcoins;
                    localStorage.setItem('flipsidCurrentUser', JSON.stringify(currentUser));
                }
            }

            await Promise.all([
                saveCard(card),
                deletePendingCard(cardId),
                saveInteractions(cardId, ix),
                uploader ? saveUser(uploader) : Promise.resolve(),
                saveMeta()
            ]);

            loadBrowseCards();
            populateClubsDropdown();
            populateTypesDropdown();
            updateFilterOptions();
            renderAdminCards();
            alert(`‚úÖ Card approved! ${uploader ? uploader.nickname + ' earned 1 FlipCoin! üéâ' : ''}`);
        }

        async function rejectCard(cardId) {
            if (!confirm('Reject this card?')) return;
            await deletePendingCard(cardId);
            renderAdminCards();
        }

        async function deleteCard(cardId) {
            if (!confirm('Permanently delete this card?')) return;
            await deleteCardFromDB(cardId);
            renderAdminCards();
            loadBrowseCards();
        }

        // ============================================================
        // EDIT CARD MODAL
        // ============================================================

        function openEditCardModal(cardId, isPending) {
            const card = isPending
                ? pendingCards.find(c => String(c.id) === String(cardId))
                : cards.find(c => String(c.id) === String(cardId));
            if (!card) return;

            document.getElementById('editCardId').value        = cardId;
            document.getElementById('editCardPending').value   = isPending ? 'true' : 'false';
            document.getElementById('editPlayerName').value    = card.playerName;
            document.getElementById('editTeam').value          = card.team;
            document.getElementById('editCardType').value      = card.cardType;
            document.getElementById('editCompany').value       = card.company;
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }

        async function saveEditedCard() {
            const cardId    = document.getElementById('editCardId').value;
            const isPending = document.getElementById('editCardPending').value === 'true';
            const card = isPending
                ? pendingCards.find(c => String(c.id) === String(cardId))
                : cards.find(c => String(c.id) === String(cardId));
            if (!card) return;

            card.playerName = document.getElementById('editPlayerName').value.trim();
            card.team       = document.getElementById('editTeam').value.trim();
            card.cardType   = document.getElementById('editCardType').value.trim();
            card.company    = document.getElementById('editCompany').value.trim();

            if (isPending) await savePendingCard(card);
            else           await saveCard(card);

            closeEditModal();
            renderAdminCards();
            loadBrowseCards();
        }

        // also keep editApprovedCard as alias for backward compat
        function editApprovedCard(cardId) { openEditCardModal(cardId, false); }

        // ============================================================
        // IMAGE MODAL
        // ============================================================

        function openModal(src) {
            if (!src) return;
            document.getElementById('imageModal').classList.add('active');
            document.getElementById('modalImage').src = src;
        }
        function closeModal() { document.getElementById('imageModal').classList.remove('active'); }

        // ============================================================
        // USER LIST MODAL (who loved/owns/wants)
        // ============================================================

        function showUserList(cardId, type) {
            const ix   = cardInteractions[String(cardId)] || cardInteractions[cardId] || {};
            const ids  = (type === 'likes' ? ix.likes : type === 'owns' ? ix.owns : ix.wants) || [];
            const card = cards.find(c => String(c.id) === String(cardId));
            const title = type === 'likes' ? '‚ù§Ô∏è Loved by' : type === 'owns' ? 'üí™ Owned by' : 'ü§≤ Wanted by';

            let html = `<h3 style="color:#ffaf00;margin-bottom:15px;">${title}</h3>`;
            if (ids.length === 0) { html += '<p style="color:#999;">Nobody yet!</p>'; }
            else {
                ids.forEach(uid => {
                    const u = users.find(x => String(x.id) === String(uid));
                    if (!u) return;
                    html += `<div class="user-list-item" style="cursor:pointer;" onclick="viewUserProfile(${u.id})">
                        ${u.profilePic ? `<img src="${u.profilePic}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` : `<div class="user-avatar" style="width:40px;height:40px;">${u.nickname.charAt(0).toUpperCase()}</div>`}
                        <strong>${u.nickname}</strong>
                    </div>`;
                });
            }
            document.getElementById('userListContent').innerHTML = html;
            document.getElementById('userListModal').classList.add('active');
        }
        function closeUserListModal() { document.getElementById('userListModal').classList.remove('active'); }

        // ============================================================
        // FOLLOWS
        // ============================================================

        async function toggleFollow(userId) {
            const myId  = String(currentUser.id);
            const theirId = String(userId);
            if (!follows[myId]) follows[myId] = { following: [], requests: [] };
            const fd = follows[myId];
            if (!fd.following) fd.following = [];
            const idx = fd.following.map(String).indexOf(theirId);
            if (idx >= 0) fd.following.splice(idx, 1);
            else fd.following.push(theirId);
            await saveFollows(currentUser.id, fd);
            loadFriends();
        }

        async function sendFollowRequest(userId) {
            const myId    = String(currentUser.id);
            const theirId = String(userId);
            if (!follows[myId]) follows[myId] = { following: [], requests: [] };
            const fd = follows[myId];
            if (!fd.requests) fd.requests = [];
            if (!fd.requests.map(String).includes(theirId)) fd.requests.push(theirId);
            await saveFollows(currentUser.id, fd);
            loadFriends();
        }

        async function acceptFollowRequest(requesterId) {
            const myId = String(currentUser.id);
            const rId  = String(requesterId);
            // Remove request from requester's follows doc
            if (follows[rId] && follows[rId].requests) {
                follows[rId].requests = follows[rId].requests.filter(x => String(x) !== myId);
                await saveFollows(requesterId, follows[rId]);
            }
            // Add to my followers (add them to my following too for mutual)
            if (!follows[myId]) follows[myId] = { following: [], requests: [] };
            if (!follows[myId].following) follows[myId].following = [];
            if (!follows[myId].following.map(String).includes(rId)) follows[myId].following.push(rId);
            await saveFollows(currentUser.id, follows[myId]);
            followRequests = buildFollowRequests();
            loadFriends();
            updateFollowRequestBadge();
        }

        async function rejectFollowRequest(requesterId) {
            const myId = String(currentUser.id);
            const rId  = String(requesterId);
            if (follows[rId] && follows[rId].requests) {
                follows[rId].requests = follows[rId].requests.filter(x => String(x) !== myId);
                await saveFollows(requesterId, follows[rId]);
            }
            followRequests = buildFollowRequests();
            loadFriends();
            updateFollowRequestBadge();
        }

        function updateFollowRequestBadge() {
            const myRequests = followRequests[String(currentUser.id)] || [];
            const badge = document.getElementById('friendRequestBadge');
            if (!badge) return;
            if (myRequests.length > 0) { badge.textContent = myRequests.length; badge.style.display = 'inline'; }
            else badge.style.display = 'none';
        }

        // ============================================================
        // FRIENDS TAB
        // ============================================================

        function loadFriends() {
            const container = document.getElementById('friendsContent');
            const myId = String(currentUser.id);
            const myFollows = follows[myId] || {};
            const following = (myFollows.following || []).map(String);
            const followers = Object.keys(follows).filter(uid =>
                uid !== myId && follows[uid].following && follows[uid].following.map(String).includes(myId)
            ).map(String);

            const pendingToMe = followRequests[myId] || [];
            const allFriendIds = [...new Set([...following, ...followers])];
            const allFriends = allFriendIds
                .map(id => users.find(u => String(u.id) === id))
                .filter(u => u && !u.isSuperAdmin);

            let html = '';

            // Follow requests
            if (pendingToMe.length > 0) {
                html += '<div class="section-header" style="background:linear-gradient(135deg,#FF9800,#F57C00);">üîî Follow Requests (' + pendingToMe.length + ')</div>';
                html += '<div style="display:grid;gap:15px;margin-bottom:30px;">';
                pendingToMe.forEach(rid => {
                    const r = users.find(u => String(u.id) === String(rid));
                    if (!r) return;
                    html += `<div class="user-list-item" style="border-color:#FF9800;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:10px;">
                                ${r.profilePic ? `<img src="${r.profilePic}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` : `<div class="user-avatar" style="width:40px;height:40px;">${r.nickname.charAt(0).toUpperCase()}</div>`}
                                <strong>${r.nickname}</strong>
                            </div>
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button class="btn-approve" onclick="acceptFollowRequest(${r.id})">Accept</button>
                            <button class="btn-reject"  onclick="rejectFollowRequest(${r.id})">Decline</button>
                        </div>
                    </div>`;
                });
                html += '</div>';
            }

            // Friends
            if (allFriends.length > 0) {
                html += '<div class="section-header">üë• Friends (' + allFriends.length + ')</div>';
                html += '<div style="display:grid;gap:15px;margin-bottom:30px;">';
                allFriends.forEach(user => {
                    const isFollowing = following.includes(String(user.id));
                    const isFollower  = followers.includes(String(user.id));
                    const hasSentReq  = myFollows.requests && myFollows.requests.map(String).includes(String(user.id));
                    html += `<div class="user-list-item">
                        <div style="flex:1;cursor:pointer;" onclick="viewUserProfile(${user.id})">
                            <div style="display:flex;align-items:center;gap:10px;">
                                ${user.profilePic ? `<img src="${user.profilePic}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` : `<div class="user-avatar" style="width:40px;height:40px;">${user.nickname.charAt(0).toUpperCase()}</div>`}
                                <div>
                                    <strong>${user.nickname}</strong>
                                    <div style="font-size:0.8em;color:#999;margin-top:2px;">
                                        ${isFollowing && isFollower ? 'üë• Mutual' : isFollowing ? '‚û°Ô∏è Following' : '‚¨ÖÔ∏è Follower'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;">
                            ${isFollowing
                                ? `<button class="follow-btn following" onclick="toggleFollow(${user.id})">‚úì Following</button>`
                                : hasSentReq
                                    ? `<button class="btn-small btn-secondary" disabled>Request Sent</button>`
                                    : `<button class="follow-btn" onclick="toggleFollow(${user.id})">+ Follow</button>`}
                            <button class="btn-small btn-secondary" onclick="viewUserProfile(${user.id})">View Cards</button>
                        </div>
                    </div>`;
                });
                html += '</div>';
            }

            // Discover
            const allFriendIdSet = new Set([...allFriendIds, myId]);
            const discover = users.filter(u =>
                !u.isSuperAdmin &&
                !allFriendIdSet.has(String(u.id))
            );

            if (discover.length > 0) {
                html += '<div class="section-header">üîç Discover Users</div>';
                html += '<div style="display:grid;gap:15px;">';
                discover.forEach(user => {
                    const hasSentReq = myFollows.requests && myFollows.requests.map(String).includes(String(user.id));
                    html += `<div class="user-list-item">
                        <div style="flex:1;cursor:pointer;" onclick="viewUserProfile(${user.id})">
                            <div style="display:flex;align-items:center;gap:10px;">
                                ${user.profilePic ? `<img src="${user.profilePic}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` : `<div class="user-avatar" style="width:40px;height:40px;">${user.nickname.charAt(0).toUpperCase()}</div>`}
                                <div>
                                    <strong>${user.nickname}</strong>
                                    ${user.isAdmin ? '<span style="background:#ff4444;color:white;padding:2px 6px;border-radius:4px;font-size:0.7em;margin-left:5px;">ADMIN</span>' : ''}
                                    ${hasSentReq ? '<div style="color:#FF9800;font-size:0.75em;">Request Sent</div>' : ''}
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;flex-direction:column;">
                            ${hasSentReq
                                ? `<button class="btn-small btn-secondary" disabled>Request Sent</button>`
                                : `<button class="follow-btn" onclick="toggleFollow(${user.id});loadFriends();">+ Follow</button>`}
                            <button class="btn-small btn-secondary" onclick="viewUserProfile(${user.id})">View Cards</button>
                        </div>
                    </div>`;
                });
                html += '</div>';
            } else if (allFriends.length === 0 && pendingToMe.length === 0) {
                html += `<div class="empty-state"><div class="empty-state-icon">üë•</div><h3>No other users yet</h3><p>Share FlipSid with your friends so they can sign up!</p></div>`;
            }

            container.innerHTML = html;
            updateFollowRequestBadge();
        }

        // ============================================================
        // USER PROFILE VIEW
        // ============================================================

        let currentViewingUserId = null;

        function viewUserProfile(userId) {
            currentViewingUserId = userId;
            const user = users.find(u => String(u.id) === String(userId));
            if (!user) return;
            const userCards = cards.filter(c => String(c.uploadedBy) === String(userId) && c.approved !== false);
            const modal = document.getElementById('userProfileModal');

            document.getElementById('profileModalNickname').textContent = user.nickname;
            document.getElementById('profileModalFullName').textContent  = user.fullName || '';
            document.getElementById('profileModalFlipcoins').textContent = user.flipcoins || 0;

            const picEl = document.getElementById('profileModalPic');
            if (user.profilePic) { picEl.src = user.profilePic; picEl.style.display='block'; }
            else picEl.style.display = 'none';

            document.getElementById('profileModalAvatar').textContent = user.profilePic ? '' : user.nickname.charAt(0).toUpperCase();
            document.getElementById('profileModalCards').innerHTML = userCards.length > 0
                ? `<div class="cards-grid">${userCards.map(c => renderCard(c, false)).join('')}</div>`
                : '<p style="color:#999;text-align:center;">No cards uploaded yet</p>';

            modal.classList.add('active');
        }

        function closeUserProfile() { document.getElementById('userProfileModal').classList.remove('active'); }

        // ============================================================
        // EDIT PROFILE
        // ============================================================

        function showEditProfile() {
            document.getElementById('editProfileNickname').value = currentUser.nickname;
            document.getElementById('editProfileFullName').value  = currentUser.fullName || '';
            document.getElementById('editProfileMobile').value    = currentUser.mobile || '';
            document.getElementById('editProfilePassword').value  = '';
            
            if (currentUser.profilePic) {
                document.getElementById('editProfileCurrentPic').src = currentUser.profilePic;
                document.getElementById('editProfileCurrentPic').style.display = 'block';
                document.getElementById('editProfilePicPlaceholder').style.display = 'none';
            } else {
                document.getElementById('editProfileCurrentPic').style.display = 'none';
                document.getElementById('editProfilePicPlaceholder').style.display = 'flex';
                document.getElementById('editProfilePicPlaceholder').textContent = currentUser.nickname.charAt(0).toUpperCase();
            }
            
            document.getElementById('editProfileModal').classList.add('active');
        }

        function closeEditProfile() { document.getElementById('editProfileModal').classList.remove('active'); }

        async function saveProfile() {
            const newNickname = document.getElementById('editProfileNickname').value.trim();
            const newFullName = document.getElementById('editProfileFullName').value.trim();
            const newMobile   = document.getElementById('editProfileMobile').value.trim();
            const newPassword = document.getElementById('editProfilePassword').value;
            const picInput    = document.getElementById('editProfilePicInput');

            if (!newNickname) { alert('Nickname cannot be empty!'); return; }
            if (users.find(u => u.nickname === newNickname && String(u.id) !== String(currentUser.id))) {
                alert('Nickname already taken!'); return;
            }

            const user = users.find(u => String(u.id) === String(currentUser.id));
            if (!user) return;

            user.nickname  = newNickname;
            user.fullName  = newFullName;
            user.mobile    = newMobile;
            if (newPassword && newPassword.length >= 4) user.password = newPassword;

            if (picInput && picInput.files[0]) {
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    user.profilePic = await compressImage(ev.target.result);
                    currentUser = {...user};
                    await saveUser(user);
                    localStorage.setItem('flipsidCurrentUser', JSON.stringify(currentUser));
                    showDashboard();
                    closeEditProfile();
                };
                reader.readAsDataURL(picInput.files[0]);
                return;
            }

            currentUser = {...user};
            await saveUser(user);
            localStorage.setItem('flipsidCurrentUser', JSON.stringify(currentUser));
            showDashboard();
            closeEditProfile();
        }

        // ============================================================
        // CLUBS & TYPES
        // ============================================================

        function populateClubsDropdown() {
            const sel = document.getElementById('uploadPlayerTeam');
            if (!sel) return;
            sel.innerHTML = '<option value="">Select Team...</option>' +
                approvedClubs.map(c => `<option value="${c.name}">${c.name}</option>`).join('') +
                '<option value="__custom__">+ Add New Team</option>';
        }

        function handleClubSelect(sel) {
            const customInput = document.getElementById('uploadPlayerTeamCustom');
            const display = document.getElementById('clubIconDisplay');
            
            if (sel.value === '__custom__') {
                if (customInput) customInput.style.display = 'block';
                if (display) { display.innerHTML = ''; display.dataset.icon = ''; }
                return;
            }
            
            if (customInput) customInput.style.display = 'none';
            
            if (!display) return;
            const club = approvedClubs.find(c => c.name === sel.value);
            if (club && club.icon) {
                display.innerHTML = `<img src="${club.icon}" style="width:30px; height:30px; border-radius:6px; object-fit:cover;">`;
                display.dataset.icon = club.icon;
            } else {
                display.innerHTML = '';
                display.dataset.icon = '';
            }
        }

        function populateTypesDropdown() {
            const sel = document.getElementById('uploadCardType');
            if (!sel) return;
            sel.innerHTML = '<option value="">Select Type...</option>' +
                approvedTypes.map(t => `<option value="${t}">${t}</option>`).join('') +
                '<option value="__custom__">+ Add New Type</option>';
        }

        function handleTypeSelect(sel) {
            const customInput = document.getElementById('uploadCardTypeCustom');
            if (sel.value === '__custom__') {
                if (customInput) customInput.style.display = 'block';
            } else {
                if (customInput) customInput.style.display = 'none';
            }
        }

        function previewClubIcon(input, previewId, placeholderId) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById(previewId).src = e.target.result;
                document.getElementById(previewId).style.display = 'block';
                if (placeholderId) document.getElementById(placeholderId).style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        function loadClubsList() {
            const container = document.getElementById('clubsList');
            if (!container) return;
            container.innerHTML = approvedClubs.map((c, i) => `
                <div style="display:flex;align-items:center;gap:10px;padding:10px;background:white;border-radius:8px;border:2px solid #ffd93d;margin-bottom:8px;">
                    ${c.icon ? `<img src="${c.icon}" style="width:40px;height:40px;border-radius:8px;object-fit:cover;">` : '<div style="width:40px;height:40px;border-radius:8px;background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:0.8em;">‚öΩ</div>'}
                    <span style="flex:1;font-weight:bold;">${c.name}</span>
                    <button class="btn-edit" onclick="openEditClubModal(${i})" style="width:auto;padding:4px 10px;">Edit</button>
                    <button class="btn-reject" onclick="removeClub(${i})" style="width:auto;padding:4px 10px;">Remove</button>
                </div>`).join('') || '<p style="color:#999;">No clubs yet</p>';
        }

        async function addClub() {
            const name = document.getElementById('newClubName').value.trim();
            const iconInput = document.getElementById('newClubIconInput');
            
            if (!name) { alert('Enter a club name'); return; }
            if (approvedClubs.find(c => c.name === name)) { alert('Club already exists'); return; }
            
            if (iconInput && iconInput.files[0]) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const compressed = await compressImage(e.target.result);
                    approvedClubs.push({name, icon: compressed});
                    await saveMeta();
                    loadClubsList();
                    populateClubsDropdown();
                    document.getElementById('newClubName').value = '';
                    iconInput.value = '';
                    document.getElementById('newClubIconPreview').innerHTML = 'Logo';
                };
                reader.readAsDataURL(iconInput.files[0]);
            } else {
                approvedClubs.push({name, icon: null});
                await saveMeta();
                loadClubsList();
                populateClubsDropdown();
                document.getElementById('newClubName').value = '';
            }
        }

        function openEditClubModal(index) {
            const club = approvedClubs[index];
            if (!club) return;
            document.getElementById('editClubIndex').value = index;
            document.getElementById('editClubName').value  = club.name;
            
            if (club.icon) {
                document.getElementById('editClubIconPreview').src = club.icon;
                document.getElementById('editClubIconPreview').style.display = 'block';
                document.getElementById('editClubIconPlaceholder').style.display = 'none';
            } else {
                document.getElementById('editClubIconPreview').style.display = 'none';
                document.getElementById('editClubIconPlaceholder').style.display = 'flex';
            }
            
            document.getElementById('editClubModal').classList.add('active');
        }

        async function saveEditedClub() {
            const index = parseInt(document.getElementById('editClubIndex').value);
            const club  = approvedClubs[index];
            if (!club) return;
            
            const newName = document.getElementById('editClubName').value.trim();
            const iconInput = document.getElementById('editClubIconInput');
            
            if (!newName) { alert('Club name cannot be empty'); return; }
            if (approvedClubs.find((c, i) => c.name === newName && i !== index)) {
                alert('Club name already exists'); return;
            }
            
            club.name = newName;
            
            if (iconInput && iconInput.files[0]) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    club.icon = await compressImage(e.target.result);
                    await saveMeta();
                    document.getElementById('editClubModal').classList.remove('active');
                    loadClubsList();
                    populateClubsDropdown();
                };
                reader.readAsDataURL(iconInput.files[0]);
                return;
            }
            
            await saveMeta();
            document.getElementById('editClubModal').classList.remove('active');
            loadClubsList();
            populateClubsDropdown();
        }

        async function removeClub(index) {
            if (!confirm('Remove this club?')) return;
            approvedClubs.splice(index, 1);
            await saveMeta();
            loadClubsList();
            populateClubsDropdown();
        }

        function loadTypesList() {
            const container = document.getElementById('typesList');
            if (!container) return;
            container.innerHTML = approvedTypes.map((t, i) => `
                <div style="display:flex;align-items:center;gap:10px;padding:10px;background:white;border-radius:8px;border:2px solid #ffd93d;margin-bottom:8px;">
                    <span style="flex:1;font-weight:bold;">üè∑Ô∏è ${t}</span>
                    <button class="btn-reject" onclick="removeType(${i})" style="width:auto;padding:4px 10px;">Remove</button>
                </div>`).join('') || '<p style="color:#999;">No types yet</p>';
        }

        async function addCardType() {
            const type = document.getElementById('newCardType').value.trim();
            if (!type) { alert('Enter a card type'); return; }
            if (approvedTypes.includes(type)) { alert('Type already exists'); return; }
            approvedTypes.push(type);
            await saveMeta();
            loadTypesList();
            populateTypesDropdown();
            document.getElementById('newCardType').value = '';
        }

        async function removeType(index) {
            if (!confirm('Remove this type?')) return;
            approvedTypes.splice(index, 1);
            await saveMeta();
            loadTypesList();
            populateTypesDropdown();
        }

        // ============================================================
        // SUPER ADMIN
        // ============================================================

        function loadAdminsList() {
            const container = document.getElementById('adminsList');
            if (!container) return;
            const admins = users.filter(u => u.isAdmin && !u.isSuperAdmin);
            container.innerHTML = admins.length === 0 ? '<p style="color:#999;">No admins yet</p>' :
                admins.map(u => `
                    <div style="display:flex;align-items:center;gap:10px;padding:10px;background:white;border-radius:8px;border:2px solid #9C27B0;margin-bottom:8px;">
                        <strong style="flex:1;">${u.nickname}</strong>
                        <button class="btn-reject" onclick="removeAdminRole(${u.id})" style="width:auto;padding:4px 10px;">Remove</button>
                    </div>`).join('');
        }

        async function searchAndPromoteUser() {
            const nick = document.getElementById('searchUserNickname').value.trim();
            const user = users.find(u => u.nickname.toLowerCase() === nick.toLowerCase() && !u.isSuperAdmin);
            if (!user) { alert('User not found'); return; }
            if (user.isAdmin) { alert('Already an admin'); return; }
            user.isAdmin = true;
            await saveUser(user);
            loadAdminsList();
            renderAdminUsers();
            alert(`${user.nickname} is now an admin! üéâ`);
        }

        // ============================================================
        // FILTER OPTIONS
        // ============================================================

        function updateFilterOptions() {
            const clubSel = document.getElementById('filterTeam');
            const typeSel = document.getElementById('filterType');
            if (clubSel) {
                clubSel.innerHTML = '<option value="">All Teams</option>' +
                    approvedClubs.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            }
            if (typeSel) {
                typeSel.innerHTML = '<option value="">All Types</option>' +
                    approvedTypes.map(t => `<option value="${t}">${t}</option>`).join('');
            }
        }

        // ============================================================
        // BOOT
        // ============================================================

        window.onload = async function() {
            await loadAllData();
            checkAuth();
        };
    </script>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="edit-modal-content" onclick="event.stopPropagation()">
            <h2 style="color:#ffaf00; margin-bottom:20px;">‚úèÔ∏è Edit User</h2>
            <input type="hidden" id="editUserModalId">
            <div class="form-group">
                <label>Profile Picture</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <img id="editUserModalPic" style="width:60px; height:60px; border-radius:50%; object-fit:cover; display:none;">
                    <div id="editUserModalPicPlaceholder" class="user-avatar" style="width:60px; height:60px; font-size:1.2em; cursor:pointer;"></div>
                    <button type="button" class="btn-small" onclick="document.getElementById('editUserModalPicInput').click()">Choose Photo</button>
                </div>
                <input type="file" id="editUserModalPicInput" accept="image/*" style="display:none;" onchange="previewProfilePic(this, 'editUserModalPic', 'editUserModalPicPlaceholder')">
            </div>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="editUserModalFullName">
            </div>
            <div class="form-group">
                <label>Nickname</label>
                <input type="text" id="editUserModalNickname">
            </div>
            <div class="form-group">
                <label>Mobile</label>
                <input type="text" id="editUserModalMobile" placeholder="Optional">
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn" onclick="saveEditedUser()">Save Changes</button>
                <button class="btn btn-secondary" onclick="document.getElementById('editUserModal').classList.remove('active')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div id="resetPasswordModal" class="modal">
        <div class="edit-modal-content" onclick="event.stopPropagation()">
            <h2 style="color:#9C27B0; margin-bottom:20px;">üîë Reset Password</h2>
            <input type="hidden" id="resetPasswordUserId">
            <p style="color:#666; margin-bottom:15px;">Set a new temporary password for <strong id="resetPasswordUsername"></strong></p>
            <div class="form-group">
                <label>New Password</label>
                <input type="text" id="resetPasswordInput" placeholder="Min 4 characters">
            </div>
            <div id="resetPasswordResult"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn" style="background:linear-gradient(135deg,#9C27B0,#7B1FA2);" onclick="saveResetPassword()">Set Password</button>
                <button class="btn btn-secondary" onclick="document.getElementById('resetPasswordModal').classList.remove('active')">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Club Modal -->
    <div id="editClubModal" class="modal">
        <div class="edit-modal-content" onclick="event.stopPropagation()">
            <h2 style="color:#ffaf00; margin-bottom:20px;">‚úèÔ∏è Edit Club</h2>
            <input type="hidden" id="editClubIndex">
            <div class="form-group">
                <label>Club Name</label>
                <input type="text" id="editClubName">
            </div>
            <div class="form-group">
                <label>Club Logo</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <img id="editClubIconPreview" style="width:50px; height:50px; border-radius:8px; object-fit:cover; display:none;">
                    <div id="editClubIconPlaceholder" style="width:50px; height:50px; border:2px dashed #ffd93d; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:0.8em; color:#999;">Logo</div>
                    <button type="button" class="btn-small" onclick="document.getElementById('editClubIconInput').click()">Choose Logo</button>
                    <input type="file" id="editClubIconInput" accept="image/*" style="display:none;" onchange="previewClubIcon(this, 'editClubIconPreview', 'editClubIconPlaceholder')">
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn" onclick="saveEditedClub()">Save Changes</button>
                <button class="btn btn-secondary" onclick="document.getElementById('editClubModal').classList.remove('active')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase Status Indicator -->
    <div id="firebaseStatus" style="
        position: fixed;
        bottom: 15px;
        right: 15px;
        background: rgba(0,0,0,0.75);
        color: white;
        padding: 8px 14px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: bold;
        z-index: 9999;
        display: block;
    ">üîÑ Loading...</div>

</body>
</html>
